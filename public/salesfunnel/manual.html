<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manual Post - INEXASLI</title>
    <link rel="stylesheet" href="salesflow.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" href="../../images/favicon.ico" type="image/x-icon">
    <style>
        /* Manual Post Form Styles */
        .auth-status {
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            border-left: 4px solid;
        }

        .auth-status.authenticated {
            border-left-color: #10b981;
            color: #10b981;
        }

        .auth-status.not-authenticated {
            border-left-color: #f59e0b;
            color: #f59e0b;
        }

        /* OAuth Button Styling - matching oauth-connect.html */
        .oauth-button {
            padding: 18px 40px;
            border-radius: 50px;
            font-size: 1.2em;
            font-weight: bold;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
            min-width: 280px;
            justify-content: center;
            letter-spacing: 0.5px;
            border: none;
            cursor: pointer;
            margin: 10px 0;
        }

        .oauth-button.instagram-button {
            background: linear-gradient(45deg, #405de6, #5851db, #833ab4, #c13584, #e1306c, #fd1d1d);
            color: white;
            box-shadow: 0 10px 30px rgba(64, 93, 230, 0.3);
        }
        
        .oauth-button.instagram-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 40px rgba(64, 93, 230, 0.4);
        }

        .oauth-button.connected {
            background: linear-gradient(135deg, #667eea, #764ba2) !important;
            color: #fff !important;
            font-weight: bold !important;
            pointer-events: none !important;
        }

        .platform-icon-x {
            font-family: 'Times New Roman', serif;
            font-weight: bold;
            font-style: normal;
        }

        .manual-post-form {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-label {
            display: block;
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 10px;
            color: white;
        }

        .text-input-container {
            position: relative;
        }

        .text-input {
            width: 100%;
            min-height: 120px;
            padding: 15px;
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            color: white;
            font-size: 1em;
            line-height: 1.5;
            resize: vertical;
            transition: all 0.3s ease;
        }

        .text-input:focus {
            outline: none;
            border-color: #10b981;
            background: rgba(255,255,255,0.15);
        }

        .character-counter {
            position: absolute;
            bottom: 10px;
            right: 15px;
            font-size: 0.9em;
            color: #ccc;
            background: rgba(0,0,0,0.7);
            padding: 2px 8px;
            border-radius: 4px;
        }

        .character-counter.warning {
            color: #ffcc00;
        }

        .character-counter.error {
            color: #ff4444;
        }

        .image-upload-section {
            margin-bottom: 25px;
        }

        .image-previews {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 10px;
        }

        .image-preview {
            margin-top: 15px;
            max-width: 100%;
            border-radius: 8px;
            display: block;
            position: relative;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            padding: 10px;
        }

        .preview-container {
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 120px;
        }

        .preview-img {
            max-width: 100%;
            max-height: 200px;
            border-radius: 6px;
            object-fit: cover;
        }

        .preview-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 8px;
            font-size: 0.85em;
            color: rgba(255, 255, 255, 0.8);
        }

        .preview-controls {
            position: absolute;
            top: 5px;
            right: 5px;
        }

        .remove-btn {
            background: rgba(255, 0, 0, 0.8);
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .remove-btn:hover {
            background: rgba(255, 0, 0, 1);
        }

        .btn-post {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #10b981, #059669);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }

        .btn-post:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
        }

        .btn-post:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .platform-selection {
            margin-bottom: 25px;
        }

        .platform-checkboxes {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .platform-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .platform-checkbox input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: #10b981;
        }

        .platform-checkbox label {
            color: white;
            font-size: 1em;
            cursor: pointer;
        }

        .status-message {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            display: none;
        }

        .status-message.success {
            background: rgba(16, 185, 129, 0.2);
            border: 1px solid #10b981;
            color: #10b981;
        }

        .status-message.error {
            background: rgba(255, 68, 68, 0.2);
            border: 1px solid #ff4444;
            color: #ff4444;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #10b981;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="splash-container" id="splashContainer" style="padding-top: 40px; position: absolute; top: 0; left: 0; width: 100%; z-index: 2;">
        <img src="../../public/images/favicon.svg" alt="INEXASLI Logo" class="splash-logo" style="margin-top: 20px;">
    </div>

    <div class="device-container" id="mainContent" style="opacity: 0; display: block; position: absolute; top: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 480px; z-index: 1;">

        <!-- Page Title -->
        <h1 class="page-title">Manual Social Media Post</h1>
        <p class="page-subtitle">Create and post content manually to your connected Instagram, Facebook, and X accounts. Perfect for time-sensitive updates and special announcements.</p>

        <!-- Manual Post Form -->
        <div class="manual-post-form">
            <!-- Platform Selection -->
            <div class="form-group platform-selection">
                <label class="form-label">Select Platforms *</label>
                <div class="platform-checkboxes">
                    <div class="platform-checkbox">
                        <input type="checkbox" id="platform-instagram" name="platforms" value="instagram">
                        <label for="platform-instagram">
                            <i class="fab fa-instagram"></i>
                        </label>
                    </div>
                    <div class="platform-checkbox">
                        <input type="checkbox" id="platform-facebook" name="platforms" value="facebook">
                        <label for="platform-facebook">
                            <i class="fab fa-facebook"></i>
                        </label>
                    </div>
                    <div class="platform-checkbox">
                        <input type="checkbox" id="platform-twitter" name="platforms" value="twitter">
                        <label for="platform-twitter">
                            <i class="platform-icon-x">ùïè</i>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Image Upload -->
            <div class="form-group image-upload-section">
                <label class="form-label">Upload Image (Optional)</label>
                <p style="font-size: 0.9em; color: #ccc; margin-bottom: 10px;">Supported formats: JPEG, PNG, WebP (max 5MB for cross-platform compatibility)</p>
                <div id="image-upload-container"></div>
            </div>

            <!-- Text Input -->
            <div class="form-group">
                <label class="form-label">Post Text *</label>
                <div class="text-input-container">
                    <textarea
                        id="post-text"
                        class="text-input"
                        placeholder="What's on your mind? Share your thoughts, updates, or announcements..."
                        maxlength="280"
                    ></textarea>
                    <div id="character-counter" class="character-counter">0/280</div>
                </div>
            </div>

            <!-- OAuth Button -->
            <div style="text-align: center; margin: 20px 0;">
                <button id="instagramOauthButton" class="oauth-button instagram-button" style="display: none;">
                    <i class="fab fa-instagram"></i> Connect Instagram Account
                </button>
                <button id="proceedToPostButton" class="btn-post" style="display: none; margin-top: 15px;">
                    <i class="fab fa-instagram"></i> Proceed to Post
                </button>
            </div>

            <!-- Status Message -->
            <div id="status-message" class="status-message"></div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="../../utility/piexif.js"></script>
    <script src="../../utility/imageUpload.js"></script>
    <script>
        // Check authentication status
        function checkAuthenticationStatus() {
            const instagramBtn = document.getElementById('instagramOauthButton');
            const proceedBtn = document.getElementById('proceedToPostButton');
            const sessionId = localStorage.getItem('instagram_session_id');
            const sessionExpiry = localStorage.getItem('instagram_session_expiry');
            
            if (sessionId && sessionExpiry) {
                const now = Date.now();
                const expiryTime = parseInt(sessionExpiry);
                
                if (now < expiryTime) {
                    // Valid session - hide OAuth button and show connected state
                    instagramBtn.innerHTML = '<i class="fab fa-instagram"></i> Verified and Ready to Post';
                    instagramBtn.classList.add('connected');
                    instagramBtn.disabled = true;
                    instagramBtn.style.pointerEvents = 'none';
                    instagramBtn.style.display = 'block';
                    
                    // Show proceed button
                    proceedBtn.style.display = 'block';
                } else {
                    // Expired session
                    localStorage.removeItem('instagram_session_id');
                    localStorage.removeItem('instagram_session_expiry');
                    localStorage.removeItem('instagram_username');
                    showNotAuthenticated();
                }
            } else {
                showNotAuthenticated();
            }
        }

        function showNotAuthenticated() {
            const instagramBtn = document.getElementById('instagramOauthButton');
            const proceedBtn = document.getElementById('proceedToPostButton');
            
            // Show OAuth button
            instagramBtn.style.display = 'block';
            
            // Hide proceed button
            proceedBtn.style.display = 'none';
            
            // Set up OAuth button
            const OAUTH_WORKER_URL = 'https://oauth.4hm7q4q75z.workers.dev';
            const instagramOauthUrl = `${OAUTH_WORKER_URL}/oauth/instagram/start?redirect=${encodeURIComponent(window.location.href)}`;
            
            instagramBtn.onclick = function() {
                // Validate form before proceeding
                const textInput = document.getElementById('post-text');
                const text = textInput.value.trim();
                const uploadedImages = window.manualPostImageUpload ? window.manualPostImageUpload.getImages() : [];
                const statusMessage = document.getElementById('status-message');
                
                // Check if text is present and within limits
                if (!text || text.length === 0) {
                    statusMessage.className = 'status-message error';
                    statusMessage.textContent = '‚ùå Please enter some text for your post.';
                    statusMessage.style.display = 'block';
                    return;
                }
                
                if (text.length > 280) {
                    statusMessage.className = 'status-message error';
                    statusMessage.textContent = '‚ùå Text is too long. Please keep it under 280 characters.';
                    statusMessage.style.display = 'block';
                    return;
                }
                
                // Check if image is uploaded
                if (uploadedImages.length === 0) {
                    statusMessage.className = 'status-message error';
                    statusMessage.textContent = '‚ùå Please upload a photo for your post.';
                    statusMessage.style.display = 'block';
                    return;
                }
                
                // Clear any previous messages
                statusMessage.style.display = 'none';
                
                // Proceed to OAuth
                window.location.href = instagramOauthUrl;
            };
            
            // Reset button to non-connected state
            instagramBtn.innerHTML = '<i class="fab fa-instagram"></i> Verify and Post';
            instagramBtn.classList.remove('connected');
            instagramBtn.disabled = false;
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Handle OAuth redirect with session data
            const urlParams = new URLSearchParams(window.location.search);
            
            // Check Instagram connection callback
            if (urlParams.get('instagram') === 'connected') {
                // Store session data from OAuth flow
                const sessionId = urlParams.get('session_id');
                const sessionExpiry = urlParams.get('session_expiry') || (Date.now() + 24 * 60 * 60 * 1000);
                const username = decodeURIComponent(urlParams.get('username') || 'User');
                
                if (sessionId) {
                    localStorage.setItem('instagram_session_id', sessionId);
                    localStorage.setItem('instagram_session_expiry', sessionExpiry);
                    localStorage.setItem('instagram_username', username);
                }
                
                // Clean up URL parameters
                const newUrl = window.location.pathname;
                window.history.replaceState({}, document.title, newUrl);
            }
            
            // Handle generic session parameters from OAuth worker
            if (urlParams.get('session_id')) {
                localStorage.setItem('instagram_session_id', urlParams.get('session_id'));
                localStorage.setItem('instagram_session_expiry', urlParams.get('session_expiry') || (Date.now() + 24 * 60 * 60 * 1000));
                localStorage.setItem('instagram_username', decodeURIComponent(urlParams.get('username') || 'User'));
                
                // Clean up URL
                const newUrl = window.location.pathname;
                window.history.replaceState({}, document.title, newUrl);
            }

            // Check authentication status
            checkAuthenticationStatus();

            // Hide splash after animation
            setTimeout(() => {
                const splash = document.getElementById('splashContainer');
                const main = document.getElementById('mainContent');
                if (splash && main) {
                    splash.style.display = 'none';
                    main.style.opacity = '1';
                }
            }, 2500);

            // Initialize image upload with cross-platform compatibility
            console.log('Initializing image upload...');
            const imageUpload = new ImageUploadUtility({
                maxFiles: 1,
                maxFileSize: 5 * 1024 * 1024, // 5MB (Twitter limit - most restrictive)
                acceptedTypes: ['image/jpeg', 'image/png', 'image/webp'], // Compatible with all platforms
                enableCamera: true,
                enableDragDrop: true,
                showPreview: true,
                quality: 0.85, // Good balance for file size and quality
                maxWidth: 1920, // Instagram/Facebook optimal
                maxHeight: 1080
            });
            console.log('Created ImageUploadUtility instance:', imageUpload);
            
            const container = document.getElementById('image-upload-container');
            console.log('Container element:', container);
            
            if (container) {
                imageUpload.render(container);
                console.log('Image upload rendered');
                
                // Check if the HTML was actually rendered
                setTimeout(() => {
                    const uploadUtility = container.querySelector('.image-upload-utility');
                    const previewContainer = container.querySelector('.image-previews');
                    console.log('Upload utility element:', uploadUtility);
                    console.log('Preview container element:', previewContainer);
                    console.log('Container HTML after render:', container.innerHTML.substring(0, 200) + '...');
                }, 100);
            } else {
                console.error('Could not find image-upload-container element!');
            }
            
            // Store reference globally for form submission
            window.manualPostImageUpload = imageUpload;
            
            // Override updatePreview method to add debugging
            const originalUpdatePreview = imageUpload.updatePreview.bind(imageUpload);
            imageUpload.updatePreview = function() {
                console.log('[DEBUG] updatePreview called, images array:', this.images);
                console.log('[DEBUG] showPreview option:', this.options.showPreview);
                
                const previewContainer = this.container?.querySelector('.image-previews');
                console.log('[DEBUG] Preview container found:', previewContainer);
                
                if (previewContainer) {
                    console.log('[DEBUG] Preview container innerHTML before update:', previewContainer.innerHTML);
                }
                
                // Call original method
                originalUpdatePreview();
                
                if (previewContainer) {
                    console.log('[DEBUG] Preview container innerHTML after update:', previewContainer.innerHTML);
                    console.log('[DEBUG] Preview container children count:', previewContainer.children.length);
                }
            };
            
            // Add event listener to track file uploads
            setTimeout(() => {
                if (imageUpload.container) {
                    const fileInput = imageUpload.container.querySelector('.file-input');
                    if (fileInput) {
                        fileInput.addEventListener('change', (e) => {
                            console.log('[DEBUG] File input changed, files:', e.target.files);
                            setTimeout(() => {
                                console.log('[DEBUG] Images in utility after file selection:', imageUpload.getImages());
                                console.log('[DEBUG] Manually calling updatePreview...');
                                imageUpload.updatePreview();
                            }, 1000);
                        });
                        console.log('[DEBUG] File input event listener added');
                    } else {
                        console.error('[DEBUG] Could not find file input element');
                    }
                } else {
                    console.error('[DEBUG] Image upload container not found for event listener');
                }
            }, 500);

            // Character counter
            const textInput = document.getElementById('post-text');
            const charCounter = document.getElementById('character-counter');

            function updateCharacterCount() {
                const text = textInput.value;
                const count = text.length;
                charCounter.textContent = `${count}/280`;

                // Update counter color
                charCounter.classList.remove('warning', 'error');
                if (count > 250) {
                    charCounter.classList.add('warning');
                }
                if (count > 280) {
                    charCounter.classList.add('error');
                }
            }

            textInput.addEventListener('input', updateCharacterCount);

            // Proceed to Post button handler
            const proceedBtn = document.getElementById('proceedToPostButton');
            proceedBtn.addEventListener('click', async function() {
                const statusMessage = document.getElementById('status-message');
                const textInput = document.getElementById('post-text');
                const text = textInput.value.trim();
                const uploadedImages = window.manualPostImageUpload ? window.manualPostImageUpload.getImages() : [];
                
                // Show loading state
                proceedBtn.disabled = true;
                proceedBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Posting...';
                
                try {
                    // Get session data
                    const sessionId = localStorage.getItem('instagram_session_id');
                    const username = localStorage.getItem('instagram_username') || 'default';
                    
                    if (!sessionId) {
                        throw new Error('No valid session found. Please authenticate first.');
                    }
                    
                    // Get selected platforms
                    const selectedPlatforms = [];
                    const platformCheckboxes = document.querySelectorAll('input[name="platforms"]:checked');
                    platformCheckboxes.forEach(checkbox => {
                        selectedPlatforms.push(checkbox.value);
                    });
                    
                    console.log('Selected platforms:', selectedPlatforms);
                    console.log('Platform checkboxes found:', document.querySelectorAll('input[name="platforms"]').length);
                    console.log('Checked checkboxes:', platformCheckboxes.length);
                    
                    if (selectedPlatforms.length === 0) {
                        throw new Error('Please select at least one platform to post to.');
                    }
                    
                    // Prepare data for posting
                    let postData;
                    let fetchOptions;
                    
                    // Check if we have images to upload
                    if (window.manualPostImageUpload) {
                        const imageFormData = window.manualPostImageUpload.getFirstImageAsFormData();
                        if (imageFormData) {
                            // Use FormData for efficient image upload
                            postData = imageFormData;
                            postData.append('action', 'manual_post');
                            postData.append('content', text);
                            postData.append('platforms', JSON.stringify(selectedPlatforms));
                            postData.append('sessionId', sessionId);
                            
                            console.log('FormData contents:');
                            for (let [key, value] of postData.entries()) {
                                console.log(key, ':', value);
                            }
                            
                            fetchOptions = {
                                method: 'POST',
                                body: postData
                            };
                            
                            console.log('Sending FormData with image file (much more efficient than base64!)');
                        } else {
                            // No images, use regular JSON
                            postData = {
                                action: "manual_post",
                                content: text,
                                platforms: selectedPlatforms,
                                sessionId: sessionId
                            };
                            
                            fetchOptions = {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify(postData)
                            };
                        }
                    } else {
                        // No image upload utility, use regular JSON
                        postData = {
                            action: "manual_post",
                            content: text,
                            platforms: selectedPlatforms,
                            sessionId: sessionId
                        };
                        
                        fetchOptions = {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(postData)
                        };
                    }
                    
                    // Call the prompt-inexasli worker
                    const workerUrl = 'https://prompt-inexasli.4hm7q4q75z.workers.dev';
                    
                    console.log('Posting to worker:', workerUrl);
                    
                    // Call the worker
                    const response = await fetch(workerUrl, fetchOptions);
                    
                    const result = await response.json();
                    console.log('Worker response:', result);
                    
                    if (result.success) {
                        statusMessage.className = 'status-message success';
                        statusMessage.textContent = `‚úÖ ${result.message}`;
                        statusMessage.style.display = 'block';
                        
                        // Reset form
                        textInput.value = '';
                        if (window.manualPostImageUpload) {
                            window.manualPostImageUpload.clearImages();
                        }
                        updateCharacterCount();
                        
                        // Hide proceed button and show verify button again
                        proceedBtn.style.display = 'none';
                        const instagramBtn = document.getElementById('instagramOauthButton');
                        instagramBtn.innerHTML = '<i class="fab fa-instagram"></i> Verify and Post';
                        instagramBtn.classList.remove('connected');
                        instagramBtn.disabled = false;
                        instagramBtn.style.pointerEvents = 'auto';
                        
                    } else {
                        throw new Error(`Posting failed: ${response.statusText}`);
                    }
                    
                } catch (error) {
                    console.error('Posting error:', error);
                    statusMessage.className = 'status-message error';
                    statusMessage.textContent = `‚ùå Posting failed: ${error.message}`;
                    statusMessage.style.display = 'block';
                } finally {
                    // Reset button state
                    proceedBtn.disabled = false;
                    proceedBtn.innerHTML = '<i class="fab fa-instagram"></i> Proceed to Post';
                }
            });
        });
    </script>
</body>
</html>