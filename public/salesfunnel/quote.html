<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Quote - INEXASLI</title>
    <link rel="stylesheet" href="salesflow.css">
    <link rel="icon" href="../../images/favicon.ico" type="image/x-icon">
</head>
<body>
    <div class="splash-container" id="splashContainer" style="padding-top: 40px; position: absolute; top: 0; left: 0; width: 100%; z-index: 2;">
        <img src="../images/favicon.svg" alt="INEXASLI Logo" class="splash-logo" style="margin-top: 20px;">
    </div>

    <div class="device-container" id="mainContent" style="opacity: 0; display: block; z-index: 1;">
            
            <!-- Step Indicator -->
            <div class="step-indicator-placeholder"></div>

            <!-- Page Title -->
            <h1 class="page-title">Review & Complete Order</h1>
            <p class="page-subtitle">Review your subscription details and enter billing information to proceed</p>

            <!-- Quote Box -->
            <div class="quote-box">
                <h3 class="quote-box-title" style="margin-bottom: 10px;">Plan Summary</h3>
                
                <!-- Package Price Line -->
                <div class="quote-line package-line" style="margin-bottom: 4px; padding: 4px 8px; border-bottom: none;">
                    <span class="quote-line-label" id="packageNameLabel">Enterprise Package</span>
                    <span class="quote-line-amount" id="packagePriceAmount">$499/month</span>
                </div>
                
                <!-- Add-ons Lines -->
                <div id="addonsLines">
                    <!-- Add-on lines will be inserted here -->
                </div>

                <!-- Overall Total -->
                <div class="quote-total" style="padding: 8px;">
                    <span class="quote-total-label">Monthly Total</span>
                    <span class="quote-total-amount" id="totalAmount">$197/month</span>
                </div>
            </div>

            <!-- Customer Information -->
            <div class="form-section" style="margin: 30px auto;">
                <h3>Billing Information</h3>
                <form id="billingForm">
                    <div class="form-fields">
                        <input type="email" id="email" placeholder="Email Address" required>
                        <input type="text" id="fullName" placeholder="Full Name" required>
                        <input type="text" id="company" placeholder="Company Name (Optional)">
                    </div>
                </form>
            </div>

            <!-- Payment Disclaimer -->
            <div class="payment-disclaimer">
                <label style="display: block; margin-bottom: 8px; cursor: pointer;">
                    <input type="checkbox" id="tosCheckbox" required style="width: 14px; height: 14px; margin-right: 8px;">
                    I agree to the <a href="#" onclick="showSocialTerms(); return false;">Terms of Service</a>
                </label>
                <label style="display: block; margin-bottom: 12px; cursor: pointer;">
                    <input type="checkbox" id="dpaCheckbox" required style="width: 14px; height: 14px; margin-right: 8px;">
                    I agree to the <a href="#" onclick="showDPA(); return false;">Data Processing Agreement</a>
                </label>
                <p style="margin: 0; color: #ccc; font-size: 13px;">
                    Your payment information is secured with bank-level encryption.
                </p>
            </div>

            <!-- Proceed Button -->
            <button class="proceed-button" onclick="proceedToPayment()" style="margin-top: 20px;">Complete Payment</button>

            <!-- Back Button -->
            <a href="customization.html" class="btn-back">← Back to Customization</a>

<!-- Legal Footer -->
<div id="legalFooterContainer"></div>

</div>
    
    <script>
        // Splash screen transition
        const splash = document.getElementById('splashContainer');
        const main = document.getElementById('mainContent');
        
        // Start main content fade-in immediately
        main.style.transition = 'opacity 1.2s ease-in';
        
        setTimeout(() => {
            // Start crossfade
            main.style.opacity = '1';
            splash.style.opacity = '0';
            splash.style.transition = 'opacity 1.2s ease-out';
            
            setTimeout(() => {
                splash.style.display = 'none';
                main.style.position = 'static';
            }, 1200);
        }, 1500); // Show splash for 1.5 seconds

        // Load quote data on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadQuoteData();
        });

        let quoteData = null;

        function loadQuoteData() {
            const data = localStorage.getItem('quoteData');
            if (data) {
                quoteData = JSON.parse(data);
                displayQuote();
            } else {
                // Redirect back if no quote data
                window.location.href = 'packages.html';
            }
        }

        function displayQuote() {
            if (!quoteData) return;

            const { package: pkg, addons, platforms, total } = quoteData;

            // Get monthly fee from package data or fallback to calculation
            const monthlyFee = pkg.monthlyPrice || getMonthlyFee(pkg.type);
            
            // Package price is no longer used (subscription-only)

            // Get included addons for this package type
            const includedAddonIds = getIncludedAddons(pkg.type);
            
            // Separate addons into included (free) and extra (paid)
            const includedAddons = addons.filter(addon => includedAddonIds.includes(addon.id));
            const extraAddons = addons.filter(addon => !includedAddonIds.includes(addon.id));

            // Update package name and price in plan summary
            document.getElementById('packageNameLabel').textContent = `${pkg.name || pkg.type.charAt(0).toUpperCase() + pkg.type.slice(1)} Package`;
            document.getElementById('packagePriceAmount').textContent = `$${monthlyFee}/month`;

            // Add included addon lines (marked as included)
            const addonsContainer = document.getElementById('addonsLines');
            addonsContainer.innerHTML = '';
            
            includedAddons.forEach(addon => {
                const addonLine = document.createElement('div');
                addonLine.className = 'quote-line included-addon';
                addonLine.style.marginBottom = '4px';
                addonLine.style.padding = '4px 8px';
                addonLine.style.borderBottom = 'none';
                
                addonLine.innerHTML = `
                    <span class="quote-line-label">${getAddonName(addon)}</span>
                    <span class="quote-line-amount included-text">Included</span>
                `;
                addonsContainer.appendChild(addonLine);
            });

            // Add extra addon lines (charged)
            extraAddons.forEach(addon => {
                const addonLine = document.createElement('div');
                addonLine.className = 'quote-line';
                addonLine.style.marginBottom = '4px';
                addonLine.style.padding = '4px 8px';
                addonLine.style.borderBottom = 'none';
                
                // Display add-on price with correct sign
                const priceDisplay = addon.price >= 0 
                    ? `+$${addon.price}/month` 
                    : `-$${Math.abs(addon.price)}/month`;
                
                addonLine.innerHTML = `
                    <span class="quote-line-label">${getAddonName(addon)}</span>
                    <span class="quote-line-amount">${priceDisplay}</span>
                `;
                addonsContainer.appendChild(addonLine);
            });

            // Calculate monthly recurring total (base monthly + extra add-ons only)
            const extraAddonsTotal = extraAddons.reduce((sum, addon) => sum + addon.price, 0);
            const monthlyRecurringTotal = monthlyFee + extraAddonsTotal;
            
            // Update overall total (monthly subscription only)
            const totalDueToday = monthlyRecurringTotal;
            document.getElementById('totalAmount').textContent = `$${totalDueToday}/month`;

            // Update package features as cards within quote
            // const featuresContainer = document.getElementById('packageFeaturesCards');
            // featuresContainer.innerHTML = pkg.features.map(feature => 
            //     `<div class="core-feature" style="margin: 4px 0; display: block;">${feature}</div>`
            // ).join('');

            // Add plan details summary
            const planDetailsContainer = document.createElement('div');
            planDetailsContainer.style.cssText = 'margin-top: 20px; text-align: left; color: white; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 15px;';
            let detailsHTML = `<strong>Plan Details:</strong><br>`;
            detailsHTML += pkg.features.map(feature => `• ${feature}<br>`).join('');
            
            const customizationData = getJSON('customizationData', {});
            if (Object.keys(customizationData).length > 0) {
                detailsHTML += `<br><strong>Customization:</strong><br>`;
                for (const [key, value] of Object.entries(customizationData)) {
                    if (value) {
                        const displayKey = key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
                        const displayValue = Array.isArray(value) ? value.join(', ') : value;
                        detailsHTML += `• ${displayKey}: ${displayValue}<br>`;
                    }
                }
            }
            
            planDetailsContainer.innerHTML = detailsHTML;
            document.querySelector('.quote-box').appendChild(planDetailsContainer);
        }

        function getMonthlyFee(packageType) {
            const fees = { basic: 99, social: 149, pro: 299, enterprise: 499 };
            return fees[packageType] || 197;
        }

        function getAddonName(addon) {
            if (addon.name) return addon.name;
            
            // Fallback: derive name from ID
            const nameMap = {
                'photos-10': '+10 Photo Storage',
                'videos-5': '+5 Video Storage', 
                'iterations-extra': '+10 Content Refinements',
                'ai-content-generation': 'AI Content Generation',
                'white-label-chat': 'White-label Chat',
                'basic-scheduling': 'Basic Scheduling Only',
                'reduced-frequency': 'Reduced Posting Frequency'
            };
            
            return nameMap[addon.id] || addon.id;
        }

        function getIncludedAddons(packageType) {
            if (packageType === 'basic') return [];
            if (packageType === 'social') return ['photos-10', 'videos-5'];
            if (packageType === 'pro') return ['photos-10', 'videos-5', 'iterations-extra', 'ai-content-generation'];
            if (packageType === 'enterprise') return ['photos-10', 'videos-5', 'iterations-extra', 'ai-content-generation', 'white-label-chat'];
            return [];
        }

        function proceedToPayment() {
            // Validate billing form
            const email = document.getElementById('email').value;
            const fullName = document.getElementById('fullName').value;
            
            if (!email || !fullName) {
                alert('Please fill in all required fields.');
                return;
            }

            // Validate legal agreements
            const tosChecked = document.getElementById('tosCheckbox').checked;
            const dpaChecked = document.getElementById('dpaCheckbox').checked;
            
            if (!tosChecked || !dpaChecked) {
                alert('Please agree to the Terms of Service and Data Processing Agreement to continue.');
                return;
            }

            if (!quoteData) {
                alert('Quote data not found');
                return;
            }

            // Store final order data
            const orderData = {
                ...quoteData,
                monthlyFee: getMonthlyFee(quoteData.package.type),
                orderDate: new Date().toISOString(),
                orderId: 'ORD-' + Math.random().toString(36).substr(2, 9).toUpperCase()
            };

            localStorage.setItem('orderData', JSON.stringify(orderData));

            // Create Stripe checkout session directly
            createCheckoutSession(orderData);
        }

        async function createCheckoutSession(orderData) {
            const { package: selectedPackage, addons: selectedAddons = [], platforms = [] } = orderData;
            
            // Debug: Log the data being sent
            console.log('OrderData:', orderData);
            console.log('SelectedPackage:', selectedPackage);
            console.log('Platforms:', platforms);
            
            // Filter out base package from addons (defensive programming)
            const filteredAddons = selectedAddons.filter(addon => 
                addon.id !== 'base-package' && 
                addon.name !== 'Starter Social Media Automation' &&
                addon.name !== `${selectedPackage.name} Monthly`
            );
            
            // Retrieve customization data
            const customizationData = getJSON('customizationData', {});
            
            console.log('Filtered addons:', filteredAddons);
            console.log('Customization data:', customizationData);
            
            try {
                // First, store customization data and get reference ID
                let customizationId = null;
                if (Object.keys(customizationData).length > 0) {
                    console.log('Storing customization data...');
                    const storeResponse = await fetch('https://stripe-saas.4hm7q4q75z.workers.dev/store-customization', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            customizationData: customizationData
                        })
                    });
                    
                    if (!storeResponse.ok) {
                        const errorData = await storeResponse.json();
                        throw new Error('Failed to store customization data: ' + (errorData.error || 'Unknown error'));
                    }
                    
                    const storeResult = await storeResponse.json();
                    customizationId = storeResult.customizationId;
                    console.log('Customization stored with ID:', customizationId);
                }
                
                // Call backend to create checkout session
                const response = await fetch('https://stripe-saas.4hm7q4q75z.workers.dev/package-checkout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        packageType: selectedPackage.type,
                        platforms: platforms,
                        addons: filteredAddons.map(a => a.id),
                        customerEmail: document.getElementById('email').value,
                        customizationId: customizationId,
                        flow_type: "service"
                    })
                });
                
                console.log('Request payload:', {
                    packageType: selectedPackage.type,
                    platforms: platforms,
                    addons: filteredAddons.map(a => a.id),
                    customerEmail: document.getElementById('email').value,
                    customizationId: customizationId,
                    flow_type: "service"
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to create checkout session');
                }
                
                const result = await response.json();
                
                if (result.success && result.url) {
                    // Redirect to Stripe checkout
                    window.location.href = result.url;
                } else {
                    throw new Error('Invalid response from server');
                }
                
            } catch (err) {
                console.error('Checkout error:', err);
                alert('Unable to process payment. Please try again.');
            }
        }

        function showTerms() {
            showSocialTerms();
        }

        function showPrivacy() {
            showSocialPrivacy();
        }
    </script>
    
    <!-- Splash Screen Transition Script -->
    <script>
        // Splash screen transition
        document.addEventListener('DOMContentLoaded', function() {
            const splash = document.getElementById('splashContainer');
            const main = document.getElementById('mainContent');
            
            // Start main content fade-in immediately
            main.style.transition = 'opacity 1.2s ease-in';
            
            setTimeout(() => {
                // Start crossfade
                main.style.opacity = '1';
                splash.style.opacity = '0';
                splash.style.transition = 'opacity 1.2s ease-out';
                
                setTimeout(() => {
                    splash.style.display = 'none';
                    main.style.position = 'static';
                    main.style.left = 'auto';
                    main.style.transform = 'none';
                }, 1200);
            }, 1500); // Show splash for 1.5 seconds
        });
    </script>
    
    <script src="../utilities/footer.js"></script>
    <script src="../utilities/modal.js"></script>
    <script src="../utilities/step-indicator.js"></script>
    
    <script type="module">
        import { getJSON } from '../utilities/getJSON.js';
        
        // Make getJSON available globally for the checkout functions
        window.getJSON = getJSON;
    </script>
</body>
</html>
