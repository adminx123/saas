<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customize Automation</title>
    <link rel="stylesheet" href="salesflow.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" href="../../images/favicon.ico" type="image/x-icon">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
</head>
<body>
    <div class="splash-container" id="splashContainer" style="padding-top: 40px; position: absolute; top: 0; left: 0; width: 100%; z-index: 2;">
        <img src="../../public/images/favicon.svg" alt="INEXASLI Logo" class="splash-logo" style="margin-top: 20px;">
    </div>

    <div class="device-container" id="mainContent" style="opacity: 0; display: block; z-index: 1;">
        <div class="setup-header">
            <!-- Step Indicator -->
            <div class="step-indicator-placeholder"></div>
            <h1 class="page-title">Customize Automation</h1>
            <p class="page-subtitle">Tell us about your brand so we can create perfect content for your business</p>
        </div>

        <div class="package-cards">
        <!-- Main Configuration Section -->
        <div class="package-card collapsed" data-section="main">
            <div class="package-header">
                <h3 class="card-title">Main Configuration</h3>
                <div class="card-status">
                    <span class="status-text">To Do</span>
                </div>
            </div>
            <div class="card-content">
            
            <div class="form-group">
                <label class="form-label" for="timezone">Timezone for Business Purposes</label>
                <select class="form-select" id="timezone" name="timezone" required>
                    <option value="">Select your timezone</option>
                    <option value="America/New_York">Eastern Time (ET)</option>
                    <option value="America/Chicago">Central Time (CT)</option>
                    <option value="America/Denver">Mountain Time (MT)</option>
                    <option value="America/Los_Angeles">Pacific Time (PT)</option>
                    <option value="America/Anchorage">Alaska Time (AKT)</option>
                    <option value="Pacific/Honolulu">Hawaii Time (HT)</option>
                    <option value="Europe/London">London (GMT)</option>
                    <option value="Europe/Paris">Paris (CET)</option>
                    <option value="Europe/Berlin">Berlin (CET)</option>
                    <option value="Asia/Tokyo">Tokyo (JST)</option>
                    <option value="Asia/Shanghai">Shanghai (CST)</option>
                    <option value="Asia/Kolkata">India (IST)</option>
                    <option value="Australia/Sydney">Sydney (AEST)</option>
                    <option value="Pacific/Auckland">Auckland (NZST)</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label" for="brandName">Brand Name</label>
                <input type="text" class="form-input" id="brandName" name="brandName"
                    placeholder="e.g., INEXASLI, Your Company Name" required>
            </div>

            <div class="form-group">
                <label class="form-label" for="supportEmail">Support Email</label>
                <input type="email" class="form-input" id="supportEmail" name="supportEmail"
                    placeholder="e.g., support@yourcompany.com" required>
            </div>

            <div class="form-group">
                <label class="form-label">Legal URLs</label>
                <div class="legal-urls-group">
                    <input type="url" class="form-input" id="privacyUrl" name="privacyUrl"
                        placeholder="Privacy Policy URL" required>
                    <input type="url" class="form-input" id="termsUrl" name="termsUrl"
                        placeholder="Terms of Service URL" required>
                    <input type="url" class="form-input" id="dpaUrl" name="dpaUrl"
                        placeholder="Data Processing Agreement URL" required>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label" for="brandVoice">Brand Voice</label>
                <textarea class="form-textarea" id="brandVoice" name="brandVoice"
                    placeholder="Describe your brand's voice and personality (e.g., professional yet approachable, practical philosophy expert)" required></textarea>
            </div>
        </div>
        </div>

        <!-- Chat AI Configuration Section -->
            <div class="package-card collapsed" id="conversationalSection" data-section="conversational" style="display: none;">
                <div class="package-header">
                    <h3 class="card-title">Chat AI Configuration</h3>
                    <div class="card-status">
                        <span class="status-text">To Do</span>
                    </div>
                </div>
                <div class="card-content">

                <div class="form-group">
                    <label class="form-label" for="industry">Business Industry</label>
                    <select class="form-select" id="industry" name="industry" required>
                        <option value="">Select your industry</option>
                        <option value="restaurant">Restaurant/Food Service</option>
                        <option value="fitness">Fitness/Health</option>
                        <option value="retail">Retail/E-commerce</option>
                        <option value="beauty">Beauty/Wellness</option>
                        <option value="tech">Technology/Software</option>
                        <option value="consulting">Consulting/Professional Services</option>
                        <option value="real-estate">Real Estate</option>
                        <option value="automotive">Automotive</option>
                        <option value="education">Education/Training</option>
                        <option value="other">Other</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Chat Users</label>
                    <textarea class="form-textarea" id="chatAudience" name="chatAudience"
                        placeholder="Describe your target users (e.g., age, interests, demographics)" required></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">Chat Widget Name</label>
                    <input type="text" class="form-input" id="chatWidgetName" name="chatWidgetName"
                        placeholder="Enter a name for your chat widget" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Chat Colours</label>
                    <textarea class="form-textarea" id="chatColors" name="chatColors"
                        placeholder="Describe your preferred chat colours (e.g., blue theme, green accents)" required></textarea>
                </div>



                <!-- Operational Focus Selection -->
                <div class="form-group" id="roleScopeGroupChat">
                    <label class="form-label">Operational Focus</label>
                    <div class="grid-selection" id="roleScopeGridChat" data-type="single" data-name="roleScopeChat">
                        <div class="grid-item1" data-value="internal">
                            <div class="grid-item-text">Internal</div>
                        </div>
                        <div class="grid-item1" data-value="external">
                            <div class="grid-item-text">External</div>
                        </div>
                        <div class="grid-item1" data-value="both">
                            <div class="grid-item-text">Both</div>
                        </div>
                    </div>
                    <input type="hidden" name="roleScopeChat" id="roleScopeChat" required>
                </div>

                <!-- Department Selection -->
                <div class="form-group" id="functionGroupChat" style="display: none;">
                    <label class="form-label">Departments</label>
                    <div class="grid-selection" id="functionGridChat" data-type="multiple" data-name="functionsChat">
                        <div class="grid-item1" data-value="sales" data-scope="both">
                            <div class="grid-item-text">Sales</div>
                        </div>
                        <div class="grid-item1" data-value="support" data-scope="both">
                            <div class="grid-item-text">Support</div>
                        </div>
                        <div class="grid-item1" data-value="admin" data-scope="internal">
                            <div class="grid-item-text">Admin</div>
                        </div>
                        <div class="grid-item1" data-value="hr" data-scope="internal">
                            <div class="grid-item-text">HR</div>
                        </div>
                        <div class="grid-item1" data-value="operations" data-scope="both">
                            <div class="grid-item-text">Operations</div>
                        </div>
                    </div>
                    <input type="hidden" name="functionsChat" id="functionsChat" required>
                </div>

                <!-- Role Selection -->
                <div class="form-group" id="roleGroupChat" style="display: none;">
                    <label class="form-label">AI Chat Role Support</label>
                    <div class="grid-selection" id="roleGridChat" data-type="multiple" data-name="rolesChat">
                        <!-- External Roles -->
                        <div class="grid-item1" data-value="customer-service-rep" data-scope="external" data-function="support">
                            <div class="grid-item-text">Customer Service Rep</div>
                        </div>
                        <div class="grid-item1" data-value="sales-assistant" data-scope="both" data-function="sales">
                            <div class="grid-item-text">Sales Assistant</div>
                        </div>
                        <!-- Internal Roles -->
                        <div class="grid-item1" data-value="hr-assistant" data-scope="internal" data-function="hr">
                            <div class="grid-item-text">HR Assistant</div>
                        </div>
                        <div class="grid-item1" data-value="admin-assistant" data-scope="internal" data-function="admin">
                            <div class="grid-item-text">Admin Assistant</div>
                        </div>
                        <div class="grid-item1" data-value="it-support" data-scope="internal" data-function="operations">
                            <div class="grid-item-text">IT Support</div>
                        </div>
                        <div class="grid-item1" data-value="team-coordinator" data-scope="internal" data-function="operations">
                            <div class="grid-item-text">Team Coordinator</div>
                        </div>
                    </div>
                    <input type="hidden" name="rolesChat" id="rolesChat" required>
                </div>

                <!-- Category Selection (hidden for RAG - users just upload docs) -->
                <div class="form-group" id="categoryGrid" style="display: none;">
                    <label class="form-label">Knowledge Categories</label>
                    <p style="color: #666; font-size: 0.9em;">Upload any knowledge documents below - the AI will reference them for responses.</p>
                    <div class="grid-selection" id="categoryGridSelection">
                        <!-- Categories no longer required for completion -->
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Brand Assets & Knowledge Documents</label>
                    <p style="color: #666; font-size: 0.9em;">Upload your logo, brand images, and any knowledge documents (FAQs, manuals, procedures, etc.) - the AI will use them to provide accurate responses.</p>
                    <input type="file" class="form-input" id="brandFiles" name="brandFiles" multiple accept="image/*,.txt,.pdf,.doc,.docx" style="display:none;" required>
                    <button type="button" id="brandUploadBtn" class="action-button" onclick="document.getElementById('brandFiles').click()">Upload Brand Assets & Knowledge Documents</button>
                    <div id="brandFileList"></div>
                </div>
            </div>
            </div>
        <div class="package-card collapsed" id="socialSection" data-section="social">
            <div class="package-header">
                <h3 class="card-title">Social Posting Configuration</h3>
                <div class="card-status">
                    <span class="status-text">To Do</span>
                </div>
            </div>
            <div class="card-content">            <div class="form-group">
                <label class="form-label">Posting Schedule</label>
                <div class="posting-schedule-builder">
                    <div class="schedule-header">
                        <span class="schedule-label">Select preferred posting days:</span>
                    </div>
                    <div class="days-selector">
                        <div class="day-toggle" data-day="monday">
                            <div class="day-label">M</div>
                            <div class="day-full">Monday</div>
                        </div>
                        <div class="day-toggle" data-day="tuesday">
                            <div class="day-label">T</div>
                            <div class="day-full">Tuesday</div>
                        </div>
                        <div class="day-toggle" data-day="wednesday">
                            <div class="day-label">W</div>
                            <div class="day-full">Wednesday</div>
                        </div>
                        <div class="day-toggle" data-day="thursday">
                            <div class="day-label">T</div>
                            <div class="day-full">Thursday</div>
                        </div>
                        <div class="day-toggle" data-day="friday">
                            <div class="day-label">F</div>
                            <div class="day-full">Friday</div>
                        </div>
                        <div class="day-toggle" data-day="saturday">
                            <div class="day-label">S</div>
                            <div class="day-full">Saturday</div>
                        </div>
                        <div class="day-toggle" data-day="sunday">
                            <div class="day-label">S</div>
                            <div class="day-full">Sunday</div>
                        </div>
                    </div>
                </div>
                <input type="hidden" name="postingSchedule" id="postingSchedule" required>
            </div>

            <div class="form-group">
                <label class="form-label">Pre-written Static Posts</label>
                <div id="staticContentContainer"></div>
                <button type="button" id="addStaticButton" class="form-button-secondary" onclick="addStaticContentItem()">+ Add Static Post</button>
                <small class="form-help">Add pre-written posts that will be randomly selected for posting</small>
            </div>

            <div class="form-group">
                <label class="form-label">Image Prompts</label>
                <div id="imagePromptContainer"></div>
                <button type="button" id="addImagePromptButton" class="form-button-secondary" onclick="addImagePromptItem()">+ Add Prompt</button>
                <small class="form-help">Add image generation prompts that will rotate daily (up to 7 prompts)</small>
            </div>
        </div>
        </div>

        <!-- Social Posting Configuration Section -->
            <div class="package-card collapsed" id="replySection" style="display: none;">
                <div class="package-header">
                    <h3 class="card-title">Social Media Reply Configuration</h3>
                    <div class="card-status">
                        <span class="status-text">To Do</span>
                    </div>
                </div>
                <div class="card-content">

                <div class="form-group">
                    <label class="form-label" for="replyGuidelines">Comment Reply Guidelines</label>
                    <textarea class="form-textarea" id="replyGuidelines" name="replyGuidelines"
                        placeholder="Specific guidelines for how the AI should respond to comments on social media posts (e.g., always be positive, focus on engagement, maintain brand voice)" required></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label" for="platformConsiderations">Platform Considerations</label>
                    <textarea class="form-textarea" id="platformConsiderations" name="platformConsiderations"
                        placeholder="Platform-specific considerations for comment replies (e.g., Instagram comments should be under 900 characters, Twitter replies should be concise)" required></textarea>
                </div>
            </div>
            </div>

        <!-- Deployment Section -->
        <div class="package-card collapsed" data-section="deployment">
            <div class="package-header">
                <h3 class="card-title">Automated Client Setup</h3>
                <div class="card-status">
                    <span class="status-text">Ready</span>
                </div>
            </div>
            <div class="card-content">
                <p>Your customized client worker and configuration will be automatically deployed after successful payment.</p>
            </div>
        </div>

        </div><!-- Close package-cards -->

        <div class="consultation-box">
            <div class="consultation-text">
                <strong>Want personalized consultation?</strong><br>
                Schedule a 15-minute brand strategy call for enhanced customization
            </div>
            <a href="#" class="btn-primary" onclick="scheduleConsultation()">
                üìû Schedule Call (Optional)
            </a>
        </div>
 
        <!-- Continue Button -->
        <button class="package-continue-btn" onclick="submitCustomizationForm()">Continue to Quote</button>
        

        <!-- Back Button -->
        <a href="packages.html" class="btn-back">‚Üê Back to Packages</a>

          
    
        <!-- Legal Footer -->
        <div id="legalFooterContainer"></div>
    
    </div><!-- Close device-container -->         
            
         
       
    
    
    
    <script>
        // Splash screen transition
        document.addEventListener('DOMContentLoaded', function() {
            const splash = document.getElementById('splashContainer');
            const main = document.getElementById('mainContent');
            
            if (!splash || !main) {
                console.error('Splash or main content elements not found');
                return;
            }
            
            // Start main content fade-in immediately
            main.style.transition = 'opacity 1.2s ease-in';
            
            setTimeout(() => {
                // Start crossfade
                main.style.opacity = '1';
                splash.style.opacity = '0';
                splash.style.transition = 'opacity 1.2s ease-out';
                
                setTimeout(() => {
                    splash.style.display = 'none';
                    main.style.position = 'static';
                    main.style.left = 'auto';
                    main.style.transform = 'none';
                    main.style.top = 'auto';
                }, 1200);
            }, 1500); // Show splash for 1.5 seconds
        });
    </script>
    
    <script>
        // Global function for checking card completion
        function checkCardCompletion(card) {
            
            const grids = card.querySelectorAll('.grid-selection');
            let allGridsCompleted = true;
            grids.forEach(grid => {
                if (grid.style.display === 'none') {
                    return; // Skip hidden grids
                }
                // Skip categoryGridSelection for conversational section (RAG doesn't need categories)
                if (card.id === 'conversationalSection' && grid.id === 'categoryGridSelection') {
                    return;
                }
                const items = grid.querySelectorAll('.grid-item1');
                const selectedItems = Array.from(items).filter(i => i.classList.contains('selected'));
                const hasSelection = selectedItems.length > 0;
                if (!hasSelection) allGridsCompleted = false;
            });
            
            // Also check required form elements (selects and inputs)
            const requiredSelects = card.querySelectorAll('select[required]');
            let allSelectsCompleted = true;
            requiredSelects.forEach(select => {
                const hasValue = !!select.value;
                if (!hasValue) allSelectsCompleted = false;
            });
            
            const requiredInputs = card.querySelectorAll('input[required]');
            let allInputsCompleted = true;
            requiredInputs.forEach(input => {
                let hasValue = false;
                if (input.type === 'file') {
                    // Special handling for brandFiles - check the uploadedBrandFiles array
                    if (input.id === 'brandFiles') {
                        hasValue = uploadedBrandFiles.length > 0;
                    } else {
                        hasValue = input.files.length > 0;
                    }
                } else {
                    hasValue = !!input.value;
                }
                if (!hasValue) allInputsCompleted = false;
            });
            
            const requiredTextareas = card.querySelectorAll('textarea[required]');
            let allTextareasCompleted = true;
            requiredTextareas.forEach(textarea => {
                const hasValue = !!textarea.value.trim();
                if (!hasValue) allTextareasCompleted = false;
            });
            
            // Check for day toggles (at least one must be active)
            const dayToggles = card.querySelectorAll('.day-toggle');
            let hasActiveDayToggle = true; // Default to true if no day toggles exist
            if (dayToggles.length > 0) {
                hasActiveDayToggle = Array.from(dayToggles).some(toggle => toggle.classList.contains('active'));
            }
            
            // Check role documents completion - for RAG, just require some files uploaded
            let roleDocsCompleted = true;
            if (card.id === 'conversationalSection') {
                const selectedRoles = getSelectedRoles();
                if (selectedRoles.length > 0) {
                    // For RAG, just require that some knowledge files have been uploaded
                    if (uploadedBrandFiles.length === 0) {
                        roleDocsCompleted = false;
                    }
                }
            }
            
            const isComplete = allGridsCompleted && allSelectsCompleted && allInputsCompleted && allTextareasCompleted && hasActiveDayToggle && roleDocsCompleted;
            
            if (isComplete) {
                card.classList.add('completed');
                const statusText = card.querySelector('.status-text');
                if (statusText) statusText.textContent = '‚úì';
            } else {
                card.classList.remove('completed');
                const statusText = card.querySelector('.status-text');
                if (statusText) statusText.textContent = 'To Do';
            }
        }
        
        // Function to download role templates as ZIP
        function downloadRoleTemplates() {
            const selectedRoles = getSelectedRoles();
            if (selectedRoles.length === 0) {
                alert('Please select at least one role before downloading templates.');
                return;
            }
            
            // Fetch template data from worker
            const url = 'https://stripe-saas.4hm7q4q75z.workers.dev/download-templates?roles=' + selectedRoles.join(',');
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    
                    // Create ZIP file using JSZip
                    const zip = new JSZip();
                    
                    // Add each template as a text file (more universally readable)
                    Object.entries(data.templates).forEach(([role, content]) => {
                        zip.file(`${role}.txt`, content);
                    });
                    
                    // Generate and download ZIP
                    return zip.generateAsync({ type: 'blob' });
                })
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'role-templates.zip';
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                })
                .catch(error => {
                    console.error('Download failed:', error);
                    alert('Download failed. Please try again.');
                });
        }
    </script>
    
    <script>
        // Restore grid selections from hidden inputs
        function restoreGridSelections() {
            // Restore role scope
            const roleScopeInput = document.getElementById('roleScope');
            if (roleScopeInput && roleScopeInput.value) {
                const scopeItem = document.querySelector(`#roleScopeGrid .grid-item1[data-value="${roleScopeInput.value}"]`);
                if (scopeItem) {
                    scopeItem.classList.add('selected');
                }
            }
            
            // Restore functions
            const functionsInput = document.getElementById('functions');
            if (functionsInput && functionsInput.value) {
                const functionValues = functionsInput.value.split(',');
                functionValues.forEach(value => {
                    const funcItem = document.querySelector(`#functionGrid .grid-item1[data-value="${value.trim()}"]`);
                    if (funcItem) {
                        funcItem.classList.add('selected');
                    }
                });
            }
            
            // Restore roles
            const rolesInput = document.getElementById('roles');
            if (rolesInput && rolesInput.value) {
                const roleValues = rolesInput.value.split(',');
                roleValues.forEach(value => {
                    const roleItem = document.querySelector(`#roleGrid .grid-item1[data-value="${value.trim()}"]`);
                    if (roleItem) {
                        roleItem.classList.add('selected');
                    }
                });
            }
        }
        
        // Update visibility of functions and roles based on scope
        function updateVisibility() {
            // Main section has no grids requiring progressive disclosure
        }
        
        function updateVisibilityChat() {
            const selectedScopeItem = document.querySelector('#roleScopeGridChat .grid-item1.selected');
            const selectedScope = selectedScopeItem ? selectedScopeItem.dataset.value : null;
            
            if (selectedScope) {
                document.getElementById('functionGroupChat').style.display = 'block';
                
                // Filter functions
                const functions = document.querySelectorAll('#functionGridChat .grid-item1');
                functions.forEach(item => {
                    const scope = item.dataset.scope;
                    if (scope === selectedScope || scope === 'both') {
                        item.style.display = 'block';
                    } else {
                        item.style.display = 'none';
                        item.classList.remove('selected');
                    }
                });
                
                // Check selected functions
                const selectedFunctions = document.querySelectorAll('#functionGridChat .grid-item1.selected');
                const selectedFunctionValues = Array.from(selectedFunctions).map(item => item.dataset.value);
                
                if (selectedFunctions.length > 0) {
                    document.getElementById('roleGroupChat').style.display = 'block';
                    
                    // Filter roles
                    const roles = document.querySelectorAll('#roleGridChat .grid-item1');
                    roles.forEach(item => {
                        const scope = item.dataset.scope;
                        const func = item.dataset.function;
                        if ((scope === selectedScope || scope === 'both') && selectedFunctionValues.includes(func)) {
                            item.style.display = 'block';
                        } else {
                            item.style.display = 'none';
                            item.classList.remove('selected');
                        }
                    });
                    
                    // Category grid no longer needed for RAG
                    // populateCategoryGrid();
                    // document.getElementById('categoryGrid').style.display = 'block';
                } else {
                    document.getElementById('roleGroupChat').style.display = 'none';
                    document.getElementById('categoryGrid').style.display = 'none';
                }
            } else {
                document.getElementById('functionGroupChat').style.display = 'none';
                document.getElementById('roleGroupChat').style.display = 'none';
            }
        }
        
        // Grid selection functionality
        document.addEventListener('DOMContentLoaded', function() {
            const gridSelections = document.querySelectorAll('.grid-selection');
            
            gridSelections.forEach(grid => {
                const type = grid.dataset.type; // 'single' or 'multiple'
                const name = grid.dataset.name;
                const items = grid.querySelectorAll('.grid-item1');
                
                items.forEach(item => {
                    item.addEventListener('click', function() {
                        const value = this.dataset.value;
                        
                        if (type === 'single') {
                            // Single selection - clear others and select this one
                            items.forEach(i => i.classList.remove('selected'));
                            this.classList.add('selected');
                            
                            // Update hidden input
                            const hiddenInput = document.getElementById(name);
                            if (hiddenInput) {
                                hiddenInput.value = value;
                            }
                        } else {
                            // Multiple selection - toggle this item
                            this.classList.toggle('selected');
                            
                            // Update hidden input with selected values
                            const selectedItems = grid.querySelectorAll('.grid-item1.selected');
                            const selectedValues = Array.from(selectedItems).map(i => i.dataset.value);
                            const hiddenInput = document.getElementById(name);
                            if (hiddenInput) {
                                hiddenInput.value = selectedValues.join(',');
                            }
                        }
                        
                        // Progressive disclosure and filtering
                        if (grid.id.includes('Chat')) {
                            updateVisibilityChat();
                            
                            // Category grid no longer needed
                            // if (grid.id === 'roleGridChat') {
                            //     populateCategoryGrid();
                            // }
                        } else {
                            updateVisibility();
                        }
                        
                        // Check card completion
                        const card = this.closest('.package-card');
                        if (card) checkCardCompletion(card);
                    });
                });
            });
            
            // Initial visibility update
            updateVisibilityChat();
            
            // Wait for form persistence to complete, then update visibility
            setTimeout(() => {
                updateVisibilityChat();
            }, 500);
            
            // Add listeners for required form elements
            const requiredSelects = document.querySelectorAll('select[required]');
            requiredSelects.forEach(select => {
                select.addEventListener('change', function() {
                    const card = this.closest('.package-card');
                    if (card) checkCardCompletion(card);
                });
            });
            
            const requiredInputs = document.querySelectorAll('input[required]');
            requiredInputs.forEach(input => {
                input.addEventListener('input', function() {
                    const card = this.closest('.package-card');
                    if (card) checkCardCompletion(card);
                });
            });
            
            const requiredTextareas = document.querySelectorAll('textarea[required]');
            requiredTextareas.forEach(textarea => {
                textarea.addEventListener('input', function() {
                    const card = this.closest('.package-card');
                    if (card) checkCardCompletion(card);
                });
            });
            
            // Load selected package and adapt form
            const packageData = localStorage.getItem('quoteData');
            
            if (packageData) {
                const quoteData = JSON.parse(packageData);
                const selectedPackage = quoteData.package;
                
                // Optional: Add package info to page
                const subtitle = document.querySelector('.setup-subtitle');
                if (subtitle) {
                    subtitle.textContent = `Configure your AI chat and reply assistants for your business needs (Customizing ${selectedPackage.name})`;
                }
                
                // Show/hide sections based on selected package
                const packageType = selectedPackage.type; // 'basic', 'social', 'pro', 'enterprise'
                
                // Business category selection (shown for all packages since they all include chat)
                const businessCategoryGroup = document.getElementById('businessCategoryGroup');
                if (businessCategoryGroup) businessCategoryGroup.style.display = 'block';
                
                // Hide all config sections by default
                const conversationalSection = document.getElementById('conversationalSection');
                const replySection = document.getElementById('replySection');
                const socialSection = document.getElementById('socialSection');
                
                if (conversationalSection) {
                    conversationalSection.style.display = 'none';
                }
                if (replySection) {
                    replySection.style.display = 'none';
                }
                if (socialSection) {
                    socialSection.style.display = 'none';
                }
                
                // Show sections based on package type
                if (packageType === 'basic') {
                    // Basic Chat: Show conversational AI config
                    if (conversationalSection) conversationalSection.style.display = 'block';
                } else if (packageType === 'social') {
                    // Social Starter: Show social media + conversational AI config
                    if (socialSection) socialSection.style.display = 'block';
                    if (conversationalSection) conversationalSection.style.display = 'block';
                } else if (packageType === 'pro') {
                    // Pro Bundle: Show all configs
                    if (socialSection) socialSection.style.display = 'block';
                    if (conversationalSection) conversationalSection.style.display = 'block';
                    if (replySection) replySection.style.display = 'block';
                } else if (packageType === 'enterprise') {
                    // Enterprise: Show all configs
                    if (socialSection) socialSection.style.display = 'block';
                    if (conversationalSection) conversationalSection.style.display = 'block';
                    if (replySection) replySection.style.display = 'block';
                }
                
                const title = document.querySelector('.setup-title');
                if (title) title.textContent = 'Custom AI Automation';
            }
            
            // After form persistence loads, check completion status of all cards
            setTimeout(() => {
                const allCards = document.querySelectorAll('.package-card');
                allCards.forEach(card => {
                    checkCardCompletion(card);
                });
            }, 300); // Delay to ensure form persistence has loaded
        });

        // Posting schedule functionality
        document.addEventListener('DOMContentLoaded', function() {
            // Day toggle functionality
            const dayToggles = document.querySelectorAll('.day-toggle');
            dayToggles.forEach(toggle => {
                toggle.addEventListener('click', function() {
                    this.classList.toggle('active');
                    // Update hidden input for form persistence
                    const postingScheduleInput = document.getElementById('postingSchedule');
                    if (postingScheduleInput) {
                        const activeDays = Array.from(document.querySelectorAll('.day-toggle.active')).map(t => t.dataset.day);
                        postingScheduleInput.value = JSON.stringify(activeDays);
                    }
                    // Check completion status of the social media card
                    const socialCard = document.querySelector('.package-card[data-section="social"]');
                    if (socialCard) {
                        checkCardCompletion(socialCard);
                    }
                });
            });
            
            // Form section collapse/expand functionality
            const sectionTitles = document.querySelectorAll('.package-card');
            sectionTitles.forEach(card => {
                card.addEventListener('click', function(e) {
                    // Prevent collapse when clicking on form elements
                    if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'BUTTON' || e.target.closest('.grid-item1') || e.target.closest('.day-toggle')) {
                        return;
                    }
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // If this card is collapsed, expand it and collapse all others
                    if (this.classList.contains('collapsed')) {
                        // Collapse all cards first
                        sectionTitles.forEach(otherCard => {
                            otherCard.classList.add('collapsed');
                        });
                        // Then expand this one
                        this.classList.remove('collapsed');
                    } else {
                        // If already expanded, collapse it
                        this.classList.add('collapsed');
                    }
                });
            });
        });

        function getRelevantSections(packageType) {
            const sections = ['main']; // Main config always included
            
            if (packageType === 'basic' || packageType === 'social' || packageType === 'pro' || packageType === 'enterprise') {
                sections.push('conversational'); // All packages include chat
            }
            
            if (packageType === 'social' || packageType === 'pro' || packageType === 'enterprise') {
                sections.push('social'); // Social media packages
            }
            
            if (packageType === 'pro' || packageType === 'enterprise') {
                sections.push('reply'); // Reply logic for higher tiers
            }
            
            return sections;
        }

        async function submitCustomizationForm() {
            // Get current package to determine which sections should be included
            const packageData = localStorage.getItem('quoteData');
            if (!packageData) {
                alert('Package data not found. Please start over.');
                window.location.href = 'packages.html';
                return;
            }
            const quoteData = JSON.parse(packageData);
            const packageType = quoteData.package.type;
            
            // Determine which sections are relevant for this package
            const relevantSections = getRelevantSections(packageType);
            
            // Collect form data manually since no form element
            const setupData = {};
            
            // Handle regular input fields
            const inputs = document.querySelectorAll('input[name], select[name], textarea[name]');
            inputs.forEach(input => {
                if (input.type === 'checkbox') {
                    setupData[input.name] = input.checked;
                } else if (input.type === 'file') {
                    setupData[input.name] = input.multiple ? Array.from(input.files) : input.files[0];
                } else {
                    setupData[input.name] = input.value;
                }
            });
            
            // Collect legal URLs as an object
            setupData.legalUrls = {
                privacy: document.getElementById('privacyUrl').value,
                terms: document.getElementById('termsUrl').value,
                dpa: document.getElementById('dpaUrl').value
            };
            
            // Collect static content array
            setupData.staticContentArray = collectStaticContentArray();
            
            // Collect image prompt array
            setupData.imagePrompts = collectImagePromptArray();
            
            // Add brand files to setup data
            setupData.brandFiles = uploadedBrandFiles;
            
            // Handle grid selections - only if section is relevant
            if (relevantSections.includes('main')) {
                // No grids for main section
            }
            
            if (relevantSections.includes('conversational')) {
                // Tone collection removed - grid not present in HTML
            }
            
            // Collect posting schedule - only if social section is relevant
            if (relevantSections.includes('social')) {
                const postingScheduleInput = document.getElementById('postingSchedule');
                setupData.postingSchedule = postingScheduleInput ? JSON.parse(postingScheduleInput.value || '[]') : [];
            }
            
            // Package-aware data filtering: Filter setupData to only include fields from relevant sections
            // This prevents data contamination by excluding fields from sections not applicable to the current package
            const fieldSectionMap = {
                timezone: 'main',
                brandName: 'main',
                supportEmail: 'main',
                legalUrls: 'main',
                brandVoice: 'main',
                industry: 'conversational',
                roleScope: 'main',
                functions: 'main',
                roles: 'main',
                roleScopeChat: 'conversational',
                rolesChat: 'conversational',
                chatWidgetName: 'conversational',
                chatColors: 'conversational',
                brandFiles: 'conversational',
                knowledgeBase: 'conversational',
                postingSchedule: 'social',
                staticContentArray: 'social',
                replyGuidelines: 'reply',
                platformConsiderations: 'reply'
            };
            
            const filteredSetupData = {};
            for (const [key, value] of Object.entries(setupData)) {
                const section = fieldSectionMap[key];
                if (!section || relevantSections.includes(section)) {
                    filteredSetupData[key] = value;
                }
            }
            
            // Validate required fields based on relevant sections
            // First check if all relevant cards are completed
            let allCardsCompleted = true;
            const allCards = document.querySelectorAll('.package-card');
            allCards.forEach(card => {
                const section = card.dataset.section;
                if (relevantSections.includes(section) && !card.classList.contains('completed')) {
                    allCardsCompleted = false;
                    alert(`Please complete the ${card.querySelector('.card-title').textContent} section before continuing.`);
                    return;
                }
            });
            if (!allCardsCompleted) return;
            
            if (relevantSections.includes('conversational') && !filteredSetupData.rolesChat) {
                alert('Please select AI chat role support.');
                return;
            }
            
            if (relevantSections.includes('conversational') && !filteredSetupData.chatAudience) {
                alert('Please fill in the target users.');
                return;
            }
            
            if (relevantSections.includes('reply') && (!filteredSetupData.replyGuidelines || !filteredSetupData.platformConsiderations)) {
                alert('Please fill in reply guidelines and platform considerations.');
                return;
            }
            
            if (relevantSections.includes('social') && (!filteredSetupData.postingSchedule || filteredSetupData.postingSchedule.length === 0)) {
                alert('Please select at least one day for posting.');
                return;
            }
            
            // Upload files to R2 storage if any exist
            const allFilesToUpload = [...uploadedBrandFiles];
            if (allFilesToUpload.length > 0) {
                
                // Show loading indicator
                const continueBtn = document.querySelector('.package-continue-btn');
                const originalText = continueBtn.textContent;
                continueBtn.textContent = 'Uploading Files...';
                continueBtn.disabled = true;
                
                try {
                    // Create FormData with files and brand name
                    const formData = new FormData();
                    const brandName = document.getElementById('brandName').value.trim() || 'unknown';
                    formData.append('brandName', brandName);
                    allFilesToUpload.forEach((file, index) => {
                        formData.append(`file_${index}`, file);
                    });
                    
                    // Upload to stripe-saas worker
                    const uploadResponse = await fetch('https://stripe-saas.4hm7q4q75z.workers.dev/upload-files', {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (!uploadResponse.ok) {
                        throw new Error(`Upload failed: ${uploadResponse.status}`);
                    }
                    
                    const uploadResult = await uploadResponse.json();
                    
                    // Add file URLs to customization data
                    filteredSetupData.uploadedFiles = uploadResult.files;
                    
                } catch (error) {
                    console.error('File upload error:', error);
                    alert('Failed to upload files. Please try again.');
                    continueBtn.textContent = originalText;
                    continueBtn.disabled = false;
                    return;
                }
                
                // Restore button
                continueBtn.textContent = originalText;
                continueBtn.disabled = false;
            }
            
            // Generate client ID from brand name
            const brandName = filteredSetupData.brandName || 'unknown';
            const clientId = brandName.toLowerCase().replace(/[^a-z0-9]/g, '-').substring(0, 50);
            filteredSetupData.clientId = clientId;
            
            // Store customization data for Stripe integration
            setJSON('customizationData', filteredSetupData);
            
            // Redirect to quote page
            window.location.href = 'quote.html';
        }

        function scheduleConsultation() {
            // TODO: Integrate with Calendly or your scheduling system
            alert('Consultation scheduling coming soon! We\'ll contact you within 2-5 days.');
        }

        // Role categories for document requirements
        const roleCategories = {
            'customer-service-rep': ['FAQs', 'Support Scripts'],
            'sales-assistant': ['Sales Strategy', 'Product List', 'Addons'],
            'support-technician': ['Technical FAQs', 'Troubleshooting Guides'],
            'hr-assistant': ['Policies', 'Procedures'],
            'admin-assistant': ['Daily Tasks', 'Scheduling'],
            'order-fulfillment': ['Order Processing', 'Inventory Management'],
            'it-support': ['Hardware/Software Inventory', 'User Support Procedures'],
            'team-coordinator': ['Team Structure', 'Meeting Schedules']
        };

        function getSelectedRoles() {
            const rolesInput = document.getElementById('rolesChat');
            if (rolesInput && rolesInput.value) {
                const value = rolesInput.value;
                if (value.startsWith('[')) {
                    return JSON.parse(value);
                } else {
                    return value.split(',').map(s => s.trim());
                }
            }
            return [];
        }

        let uploadedBrandFiles = [];

        function handleBrandFileSelect(event) {
            const newFiles = Array.from(event.target.files);
            // Add new files to the list
            uploadedBrandFiles.push(...newFiles);
            // Clear the input to allow selecting the same files again or new ones
            event.target.value = '';
            // Update the display
            updateBrandFileDisplay();
            // Check card completion
            checkCardCompletion(document.getElementById('conversationalSection'));
        }

        function updateBrandFileDisplay() {
            const fileListDiv = document.getElementById('brandFileList');
            if (uploadedBrandFiles.length === 0) {
                fileListDiv.innerHTML = '';
            } else {
                fileListDiv.innerHTML = '';
                uploadedBrandFiles.forEach((file, index) => {
                    const fileDiv = document.createElement('div');
                    fileDiv.style.marginBottom = '10px';
                    fileDiv.innerHTML = `<strong style="color: green;">${file.name}</strong>`;
                    fileListDiv.appendChild(fileDiv);
                });
            }
        }

        function filterRolesByScope() {
            const selectedScope = document.getElementById('roleScopeChat').value;
            const roleItems = document.querySelectorAll('#roleGridChat .grid-item1');
            
            roleItems.forEach(item => {
                const itemScope = item.getAttribute('data-scope');
                if (selectedScope === 'both' || itemScope === 'both' || itemScope === selectedScope) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('brandFiles').addEventListener('change', handleBrandFileSelect);
            // Initial check
            updateBrandFileDisplay();
            
            // Add scope change listener
            const scopeGrid = document.getElementById('roleScopeGridChat');
            if (scopeGrid) {
                scopeGrid.addEventListener('click', (e) => {
                    if (e.target.closest('.grid-item1')) {
                        // Allow time for hidden input to update
                        setTimeout(filterRolesByScope, 50);
                    }
                });
            }
            
            // Initial filter
            filterRolesByScope();
        });
    </script>
    
    <script src="../utilities/footer.js"></script>
    <script src="../utilities/modal.js"></script>
    <script src="../utilities/step-indicator.js"></script>
    <script type="module">
        import { setJSON } from '../utilities/setJSON.js';
        import { getJSON } from '../utilities/getJSON.js';
        
        // Make functions available globally
        window.setJSON = setJSON;
        window.getJSON = getJSON;
        
        window.addStaticContentItem = addStaticContentItem;
        window.removeStaticContentItem = removeStaticContentItem;
        window.collectStaticContentArray = collectStaticContentArray;
        window.saveStaticContentArray = saveStaticContentArray;
        window.loadStaticContentArray = loadStaticContentArray;
        
        window.addImagePromptItem = addImagePromptItem;
        window.removeImagePromptItem = removeImagePromptItem;
        window.collectImagePromptArray = collectImagePromptArray;
        
        // Static Content Array functions
        function addStaticContentItem() {
            const container = document.getElementById('staticContentContainer');
            const existingRows = container.querySelectorAll('.content-row').length;
            
            if (existingRows >= 7) {
                alert('Maximum 7 static posts allowed');
                return;
            }
            
            const row = document.createElement('div');
            row.className = 'content-row';
            row.innerHTML = `
                <input type="text" placeholder="e.g., 'üöÄ Ready to supercharge your business with AI? DM to get started!'" class="form-input content-item" maxlength="280">
                <span class="char-counter">0/280</span>
                <button type="button" class="remove-btn" onclick="removeStaticContentItem(this)">√ó</button>
            `;
            container.appendChild(row);
            attachStaticContentListeners(row);
            updateStaticButtonState();
            saveStaticContentArray();
        }
        
        function removeStaticContentItem(button) {
            button.parentElement.remove();
            updateStaticButtonState();
            saveStaticContentArray();
        }
        
        function updateStaticButtonState() {
            const container = document.getElementById('staticContentContainer');
            const existingRows = container.querySelectorAll('.content-row').length;
            const button = document.getElementById('addStaticButton');
            button.disabled = existingRows >= 7;
            button.textContent = existingRows >= 7 ? 'Maximum 7 items reached' : '+ Add Static Post';
        }
        
        function attachStaticContentListeners(row) {
            const input = row.querySelector('.content-item');
            const counter = row.querySelector('.char-counter');
            
            function updateCounter() {
                const length = input.value.length;
                counter.textContent = `${length}/280`;
                counter.style.color = length > 250 ? '#d97706' : length > 270 ? '#dc2626' : '#6b7280';
                saveStaticContentArray();
            }
            
            input.addEventListener('input', updateCounter);
            updateCounter(); // Initial update
        }
        
        function saveStaticContentArray() {
            const rows = document.querySelectorAll('#staticContentContainer .content-row');
            const items = [];
            rows.forEach(row => {
                const value = row.querySelector('.content-item').value.trim();
                if (value) {
                    items.push(value);
                }
            });
            localStorage.setItem('staticContentData', JSON.stringify(items));
        }
        
        function loadStaticContentArray() {
            const container = document.getElementById('staticContentContainer');
            if (!container) return;
            container.innerHTML = '';
            let items = [];
            const data = localStorage.getItem('staticContentData');
            if (data && data !== '[]') {
                items = JSON.parse(data);
            } else {
                const customizationData = getJSON('customizationData', {});
                if (customizationData.staticContentArray) {
                    try {
                        const parsed = JSON.parse(customizationData.staticContentArray);
                        if (Array.isArray(parsed)) {
                            items = parsed;
                        }
                    } catch (e) {
                        // Error parsing staticContentArray from customizationData
                    }
                }
            }
            items.forEach(item => {
                addStaticContentItem();
                const rows = document.querySelectorAll('#staticContentContainer .content-row');
                const lastRow = rows[rows.length - 1];
                lastRow.querySelector('.content-item').value = item;
            });
            updateStaticButtonState();
        }
        
        function collectStaticContentArray() {
            const rows = document.querySelectorAll('#staticContentContainer .content-row');
            const items = [];
            rows.forEach(row => {
                const value = row.querySelector('.content-item').value.trim();
                if (value) {
                    items.push(value);
                }
            });
            return JSON.stringify(items);
        }
        
        // Image Prompt Array functions
        function addImagePromptItem() {
            const container = document.getElementById('imagePromptContainer');
            const existingRows = container.querySelectorAll('.content-row').length;
            
            if (existingRows >= 7) {
                alert('Maximum 7 image prompts allowed');
                return;
            }
            
            const row = document.createElement('div');
            row.className = 'content-row';
            row.innerHTML = `
                <input type="text" placeholder="e.g., 'A serene mountain landscape at sunset'" class="form-input content-item" maxlength="200">
                <span class="char-counter">0/200</span>
                <button type="button" class="remove-btn" onclick="removeImagePromptItem(this)">√ó</button>
            `;
            container.appendChild(row);
            attachImagePromptListeners(row);
            updateImagePromptButtonState();
            saveImagePromptArray();
        }
        
        function removeImagePromptItem(button) {
            button.parentElement.remove();
            updateImagePromptButtonState();
            saveImagePromptArray();
        }
        
        function updateImagePromptButtonState() {
            const container = document.getElementById('imagePromptContainer');
            const existingRows = container.querySelectorAll('.content-row').length;
            const button = document.getElementById('addImagePromptButton');
            button.disabled = existingRows >= 7;
            button.textContent = existingRows >= 7 ? 'Maximum 7 prompts reached' : '+ Add Prompt';
        }
        
        function attachImagePromptListeners(row) {
            const input = row.querySelector('.content-item');
            const counter = row.querySelector('.char-counter');
            
            function updateCounter() {
                const length = input.value.length;
                counter.textContent = `${length}/200`;
                counter.style.color = length > 180 ? '#d97706' : length > 190 ? '#dc2626' : '#6b7280';
                saveImagePromptArray();
            }
            
            input.addEventListener('input', updateCounter);
            updateCounter(); // Initial update
        }
        
        function saveImagePromptArray() {
            const rows = document.querySelectorAll('#imagePromptContainer .content-row');
            const items = [];
            rows.forEach(row => {
                const value = row.querySelector('.content-item').value.trim();
                if (value) {
                    items.push(value);
                }
            });
            localStorage.setItem('imagePromptData', JSON.stringify(items));
        }
        
        function loadImagePromptArray() {
            const container = document.getElementById('imagePromptContainer');
            if (!container) return;
            container.innerHTML = '';
            let items = [];
            const data = localStorage.getItem('imagePromptData');
            if (data && data !== '[]') {
                items = JSON.parse(data);
            } else {
                const customizationData = getJSON('customizationData', {});
                if (customizationData.imagePrompts) {
                    try {
                        const parsed = JSON.parse(customizationData.imagePrompts);
                        if (Array.isArray(parsed)) {
                            items = parsed;
                        }
                    } catch (e) {
                        // Error parsing imagePrompts from customizationData
                    }
                }
            }
            items.forEach(item => {
                addImagePromptItem();
                const rows = document.querySelectorAll('#imagePromptContainer .content-row');
                const lastRow = rows[rows.length - 1];
                lastRow.querySelector('.content-item').value = item;
            });
            updateImagePromptButtonState();
        }
        
        function collectImagePromptArray() {
            const rows = document.querySelectorAll('#imagePromptContainer .content-row');
            const items = [];
            rows.forEach(row => {
                const value = row.querySelector('.content-item').value.trim();
                if (value) {
                    items.push(value);
                }
            });
            return JSON.stringify(items);
        }
        
        // Deploy client function
        
        // Initialize form persistence for customization form after a short delay
        // to ensure grid selection event listeners are set up
        setTimeout(() => {
            // Load persisted data
            loadStaticContentArray();
            loadImagePromptArray();
        }, 100);
    </script>
</body>
</html>
